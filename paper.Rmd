---
title: "Cost-effectiveness of a malaria elimination campaign"
author: "Laia Cirera, Joe Brew, Elisa Sicuri"
date: "`r March 31, 2017`"
output:
 tufte::tufte_html: default
 tufte::tufte_handout:
   citation_package: natbib
   latex_engine: xelatex
 tufte::tufte_book:
   citation_package: natbib
   latex_engine: xelatex
bibliography: bibliography.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE)
```


```{r}
library(readxl)
library(tidyverse)
library(broom)
library(ggthemes)


# Read in costs database 
costs <- read_excel("public_data/costs.xlsx")

# Read in epi parameters 
parameters <- read_excel("public_data/parameters.xlsx")

# Read in incidence data and weatehr data
source("master.R")
bes <- df

# Create variables 
bes <- 
  bes %>%
  mutate(mda=ifelse(date<"2015-08-01", "pre_maltem", 'maltem'),
         intervention=district=="MAGUDE",
         magude = ifelse(district == 'MAGUDE', 'Magude', 'Not Magude'))

# Create a time since 2010 variable
bes <- bes %>%
  mutate(time_since_2010 = as.numeric(date - as.Date('2010-01-01')))

# Make a season variable
bes <- bes %>%
  mutate(season = ifelse(month %in% 1:5, 'high', 'low'))

# Create model to estimate effectiveness
mod <-lm(pk ~ mda*intervention + 
           irs_coverage + 
           season +
           factor(month) +
           time_since_2010, 
         data=bes %>%
           filter(date >= '2012-01-01'), 
         weights = population)
```

Model parameters

```{r}

# Explore results of linear model
# knitr::kable(tidy(summary(mod)))
```

```{r}
# Use model to predict conterfactual
other_irs <- bes %>% filter(year == 2016, district != "MAGUDE") %>% summarise(x =mean(irs_coverage, na.rm =TRUE)) %>% .$x
counter_factual <- 
   bes %>% filter(year == 2016, 
                  district == "MAGUDE")
results <- list()
for (i in 2010:2020){
  new_year <- counter_factual %>%
    mutate(year = i) 
  results[[i]] <- new_year
}
counter_factual <- bind_rows(results)
counter_factual$date <- 
  as.Date(paste0(counter_factual$year, substr(counter_factual$date, 5, 10)))

counter_factual <- 
  counter_factual %>%
  mutate(irs_coverage = other_irs) %>%
  mutate(intervention = FALSE)

counter_factual$p_cf <- predict(mod, counter_factual)
counter_factual$cases_cf <-(counter_factual$p_cf/1000)*counter_factual$population 
counter_factual$cases_averted <- counter_factual$cases_cf - counter_factual$cases

# Get sum of averted cases
ac <- counter_factual %>%
  filter(year == 2016) %>%
  group_by(age)%>%
  summarise(sum_cases_averted=sum(cases_averted))
  
# Get the reduction in incidence
inc <-
  counter_factual %>%
  filter(year == 2016) %>%
  group_by(age)%>%
  summarise(reduction = (mean(p_cf) - mean(p)) / mean(p_cf) * 100)

### Create new variables in our epi data related to clinical events
counter_factual <- 
  counter_factual %>%
  mutate(cases_non_severe = cases * parameters$value[parameters$parameter == 'p_non_sev'],
         cases_non_severe_cf = cases_cf * parameters$value[parameters$parameter == 'p_non_sev'],
         cases_severe = cases * parameters$value[parameters$parameter == 'p_sev'],
         cases_severe_cf = cases_cf * parameters$value[parameters$parameter == 'p_sev'],
         deaths = cases * parameters$value[parameters$parameter == 'cfr'],
         deaths_cf = cases_cf * parameters$value[parameters$parameter == 'cfr'],
         cost_outpatient = cases_non_severe * parameters$value[parameters$parameter == 'cost_outp_usd'],
         cost_outpatient_cf = cases_non_severe_cf * parameters$value[parameters$parameter == 'cost_outp_usd'],
        cost_inpatient = cases_severe * parameters$value[parameters$parameter == 'cost_inp_usd'],
        cost_inpatient_cf = cases_severe_cf * parameters$value[parameters$parameter == 'cost_inp_usd']) %>%
  mutate(cost_clinical = cost_inpatient + cost_outpatient,
         cost_clinical_cf = cost_inpatient_cf + cost_outpatient_cf)

# Dollars per case averted
# We have cases_averted
# We also have clinical costs saved
# We need program costs

# 2016
# dpca = program costs + real clinical costs / cf program costs + cf clinical costs

# We need to differentiate between program costs (MALTEM) and intervention costs
intervention_costs <- costs[!costs$elimination_activity %in% c('Entomology', 'REACT'),]

intervention_costs <-
  intervention_costs %>%
  # MALTEM COSTS
  mutate(cost_maltem = 
              (resource_use * 
              q_maltem *
              p_maltem *
              yearly_regularity / 
              useful_life)) %>%
  mutate(transport_meticais = ifelse(transport_cost, 0.25 * cost_maltem, 0),
         import_meticais = ifelse(import_tax, 0.4 * cost_maltem, 0),
         operating_meticais = ifelse(operating_cost, 0.1 * cost_maltem, 0),
         maintenance_meticais = ifelse(maintenance_cost, 0.15 * cost_maltem, 0)) %>%
  mutate(cost_maltem = 
           cost_maltem +
           transport_meticais +
           import_meticais +
           operating_meticais +
           maintenance_meticais) %>%
  mutate(cost_basic = 
           (resource_use * 
              q_basic *
              (p_basic_perc * p_maltem) *
              yearly_regularity / 
              useful_life)) %>%
    mutate(transport_meticais_basic = ifelse(transport_cost, 0.25 * cost_maltem, 0),
         import_meticais_basic = ifelse(import_tax, 0.2 * cost_maltem, 0),
         operating_meticais_basic = ifelse(operating_cost, 0.1 * cost_maltem, 0),
         maintenance_meticais_basic = ifelse(maintenance_cost, 0.15 * cost_maltem, 0)) %>%
    mutate(cost_basic = 
           cost_basic +
           transport_meticais_basic +
           import_meticais_basic +
           operating_meticais_basic +
           maintenance_meticais_basic) %>%
  dplyr::select(elimination_activity,
                budget_category,
                baseline_year,
                item,
                description,
                cost_basic,
                cost_maltem) %>%
  mutate(cost_basic = ifelse(is.na(cost_basic), 0, cost_basic))

# Get total intervention costs
total_intervention_cost <- 
  intervention_costs[,c('cost_basic', 'cost_maltem')]
total_intervention_cost <-
  tidy(apply(total_intervention_cost, 2, sum, na.rm = TRUE) / 75)

# Get a counterfactula for government
cf_costs <- intervention_costs %>%
  filter(elimination_activity %in% c('IRS', 'LLIN')) %>%
  summarise(x = sum(cost_basic) / 75)
cf_costs <- data_frame(names = 'counter_factual',
                       x = cf_costs$x)


total_intervention_cost <-
  bind_rows(total_intervention_cost,
            cf_costs)
names(total_intervention_cost)[2] <- 'cost'

ggplot(data = total_intervention_cost,
       aes(x= names,
           y = cost)) +
  geom_bar(stat = 'identity') +
  labs(x = 'Scenario',
       y = 'US Dollars',
       title = 'Comparative costs of malaria control/elimination approaches',
       subtitle = 'USD') +
  geom_label(aes(label = round(cost)))

# Add clinical costs to our total_intervention_cost dataset
clinical_costs <- 
  counter_factual %>%
  filter(year == 2016) %>%
  summarise(counter_factual = sum(counter_factual$cost_clinical_cf),
            cost_basic = sum(counter_factual$cost_clinical),
            cost_maltem = sum(counter_factual$cost_clinical))
clinical_costs <- tidy(t(clinical_costs))
names(clinical_costs) <- c('names', 'clinical_cost')
total_intervention_cost <-
  left_join(x = total_intervention_cost,
            y = clinical_costs,
            by = 'names')

# Get total cost (program plus clinic)
total_intervention_cost$total_cost <-
  total_intervention_cost$cost +
  total_intervention_cost$clinical_cost

# Get total cases for 2016 under both scenarios
x <- counter_factual %>%
  filter(year == 2016) %>%
  summarise(cases_maltem = sum(cases),
            cases_cf = sum(cases_cf))

DT::datatable(total_intervention_cost)

# Plot of the counterfactual and real
real <- bes %>%
  filter(district == 'MAGUDE') %>%
  mutate(status = 'observed')
cf <- counter_factual %>%
  # filter(year == 2016) %>%
  filter(year < 2017) %>%
  mutate(status = 'counterfactual') %>%
  mutate(cases = cases_cf,
         p = p_cf)
plot_data <- bind_rows(real, cf)

x <- plot_data %>%
  filter(date >= '2015-08-01') %>%
  group_by(status, year) %>%
  summarise(total_cases = sum(cases))

days_of_observation <- as.numeric(as.Date('2016-12-31') - as.Date('2015-08-01'))

plot_data <- plot_data %>%
  group_by(year, week, status) %>%
  summarise(month = first(month),
            date = first(date),
            cases = sum(cases),
            population = sum(population)) %>%
  ungroup %>%
  mutate(p = cases / population) %>%
  mutate(pk = p * 1000)


library(cism)
plot_data <- plot_data %>%
 filter(date >= '2014-07-01')
g <- ggplot(data = plot_data ,
       aes(x = date,
           y = pk,
           group = status,
           color = status)) +
  geom_line(alpha = 0.6) +
  theme_cism() +
  labs(x = 'Date',
       y = 'Weekly incidence per 1000',
       title = 'Observed vs. counterfactual',
       subtitle = 'Preliminary effectivenesss model') +
  scale_color_manual(name = 'Status',
                     values = c('darkorange', 'darkgreen'))
g +
  geom_vline(xintercept = c(as.numeric(as.Date('2015-08-01')),
                            as.numeric(as.Date('2015-11-01'))),
             alpha = 0.5,
             lty = 2)

# By mes
pdm <- plot_data %>%
  mutate(date = as.Date(paste0(year, '-',
                               month, '-01'))) %>%
  group_by(date, status) %>%
  summarise(pk = mean(pk))
ggplot(data = pdm ,
       aes(x = date,
           y = pk,
           group = status,
           color = status)) +
  geom_line(alpha = 0.6) +
  theme_cism() +
  labs(x = 'Date',
       y = 'Monthly incidence per 1,000',
       title = 'Preliminary effectiveness model',
       subtitle = 'Magude district') +
  scale_color_manual(name = '',
                     values = c('darkorange', 'darkgreen')) +
    geom_vline(xintercept = c(as.numeric(as.Date('2015-08-01')),
                            as.numeric(as.Date('2015-11-09')),
                            as.numeric(as.Date('2016-12-02'))),
             alpha = 0.5,
             lty = 2)

# Get difference b/w 2016 counterfactual and real
x <- counter_factual %>%
  filter(year == 2016) %>%
  summarise(cf = sum(cases_cf, na.rm = TRUE),
            cr = sum(cases)) %>%
  mutate(cases_averted = cf - cr)

# write a csv for laia
write_csv(plot_data, '~/Desktop/cf_vs_observed.csv')
```



# Introduction

Mozambique is one of the 10 highest-malaria burden countries in the world, with parasite prevalence ranging from 3 to more than 50%. Although large drops in transmission can be achieved in a limited timeframe, indoor residual spraying and case management alone are not sufficient to attain elimination (Okumu et al, 2011). 

Within this context and in line with the global and regional efforts towards malaria elimination, a five year malaria elimination program that started in 2014 has been established in Magude District (Mozambique) through Centro de Investiga??o em Sa?de de Manhi?a (CISM). The main objective of this program is to assist the NMCP in adopting targeted evidence-based elimination plans through a 'learn by doing' strategy that begins in program mode and incorporates data from rigorous evaluation-into action as it is continuously being generated. Besides developing a fully costed, targeted, evidence-based elimination plan for Southern Mozambique, the first two years of this program have generated knowledge to inform the programmatic aspects of the elimination plan, most importantly how to interrupt transmission. It has also provided coordination, management and capacity building support to the NMCP, and facilitated the adoption of evidence-based malaria policies through the creation of a Malaria Technical Advisory Committee in the country. 

The  MALTEM program will provide technical, operational and financial support to design and scale up new strategies for the Mozambican National Malaria Control Program (NMCP) to achieve elimination in Maputo and significantly decrease malaria transmission rates in Gaza and Inhambane provinces by 2020. 

Within this context, a rigorous costing analysis needs to be carried out in order to assess the viability of MALTEM strategies and guarantee the financial sustainability of the project across time.  Firstly, this study estimates the costs associated with malaria elimination activities in the district of Magude and models these costs, in accordance to economic theory principles, evidence from literature on malaria elimination as well as from WHO guidelines, across time. These costs are then compared with malaria control costs to identify potential savings of resources associated with malaria elimination, in the medium/long run. The whole analysis allows us assessing whether it malaria elimination (by comparing the costs of malaria elimination vs. costs of malaria control activities implementation and estimating the quantity and value of additional resource requirements to achieve malaria elimination), is financially affordable and sustainable over the next 10 years, but also, to which extend malaria elimination is also cost-effective compared to malaria control interventions.  

#Methods 

##Study area and population

The malaria elimination is taking place in Magude District, on the North-Western area of Maputo Province, Southern Mozambique. Magude District borders with the district of Massingir (Gaza Province), in the North, Manhi?a District and the province of Gaza (Chokwe and Bilene Districts) on the East, Moamba District in the South, and the South African Kruger National Park on the West. It has an area of 6,961 km2, with approximately 60,000 individuals and 11,408 family compounds. The district has seven health facilities with a total of 43 beds ^[(1.65 beds per 1,000 inhabitants)]  and reported 20,000 malaria cases per 100,000 population at risk in 2012.

Manhi?a district has been used as a comparator area for the analysis of the interventions, costing and variables of interest. Manhi?a, located 80km north of the capital, Maputo, is a semi-rural area, with a population of 165.497 habitants. As of 2016, malaria remains one of the main causes of under-five morbidity and mortality in the district. 

##Study design

The study we propose is not a randomized one. Malaria elimination activities will be carried out in Magude and not in a randomized way (it is not possible to randomize a district based malaria elimination campaign). In order to identify the impact of malaria elimination activities on indicators of impact and in order to perform the general cost-effectiveness analyses, a comparator is needed. There is rich data existent in Manhi?a district, where CISM is located. However, it is subject to important noise given all biomedical research and clinical trials carried out within the district in the last 20 years. In consequence, we will use and ponderate data at the district level.  

In the estimates we will also control for potential confounders, because good data are available. It is possible to control, for instance, for the demographic structure of people living in the districts, daily rainfall and temperature data, etc. Features of the health systems of all districts in the province are also known.

##Costs

###Costs of malaria elimination

The costing of the malaria elimination plan in Magude District consists of a detailed compilation of the estimated costs of resources used in the first 2 years and the additional resources needed to carry out the 5 year Malaria elimination program (till 2020). The main purpose of this costing analysis is to provide realistic information about the financial and economic resources used to execute the plan as well as the distribution of these resources across the years...... 


###Costs of malaria case management 

ELISA's ref. Health system costs for the treatment of a malaria episode included admission costs at the maternity ward in the case of inpatients, or the cost of attendance and treatment in the case of outpatients. Unit costs of an admission at the maternity ward (occupied bed/day) and of an external consultation included all recurrent components and excluded capital costs. Recurrent costs consisted of personnel, medical, surgical and laboratory supplies among other recurrent costs. Unit costs were updated from the year 2000 to the year 2007 using the average annual rate inflation correction
factor and validated during interviews with the administrative staff of the MDH [32]. Drug costs were added to this estimate. Quinine was the antimalarial drug administered to admitted pregnant women and to outpatient pregnant women in the first trimester of gestation. The combination of SP and artesunate was administered to outpatient pregnant women who were over the first trimester of pregnancy. Drug costs for malaria treatment are mostly sustained by the National Health System in Mozambique, and patients only pay a small fee when attending government health facilities. Total admission costs were calculated by multiplying the daily unit cost of admission at the maternity ward by the average number of admission days, which were estimated through the household cost
data collection outlined below.

##Costing scenarios and sensitivity analysis 

Explain costs of malaria control

ELISA's ref. The base case costing scenario relied on the following set of assumptions: a discount rate of 3 % was applied to capital costs; wastage of RDT kits, ACT treatment courses and other field work materials was assumed to be 10 %; overhead for national (and international) supervision amounted to 15 % of the total direct financial costs of the programme. These are believed to be conservative assumptions. The cost of ACT treatment courses and RDT kits
were based on the cost, insurance and freight (cif.) price of the drug or diagnostic derived ......


Elisa's ref. Probabilistic cost-effectiveness analysis was undertaken through Monte Carlo simulations using @Risk (version 5.0) add-in tool to Microsoft Excel. (Palisade Corporation, Ithaca, NY, USA). The main factors affecting the cost-effectiveness of the intervention were identified in the estimated model by calculating Spearman's rank correlation coefficients as a measure of the magnitude of the association between each variable and the ICERs. A threshold analysis of the cost-effectiveness of IPTp-SP was performed to estimate cut-off points beyond which the
prevention is no longer cost-effective. The threshold level of the ICERs used to define the intervention as cost-effective was 129 US$ per DALY averted, while 36 US$ per DALY averted was the threshold used to define the intervention as highly cost-effective. These threshold figures were based on previously accepted 1993 and 1996 World Bank definitions and inflated to their 2007 equivalent: 129 and 36 US$ for the year 2007 correspond to 100
and 25 US$ for the year 1993, respectively [47-49]. The costeffective intervention threshold was conservatively set at 100 instead of 150 US$ per DALY averted. Probabilistic threshold analysis was performed on SP price, other intervention costs, case fatality rate, malaria incidence, protective efficacy and antenatal clinic attendance. Furthermore, a one-way sensitivity analysis was undertaken on SP price.

##Effectiveness

All explanation on data from BES, its limitations and advantages compared to data from MALTEM's own surveillance system....... 

```{r}
x <- counter_factual
x$predicted <- predict(mod, x)
long <- gather(x, key, value, cases:predicted)
long$value <- as.numeric(long$value)
long <- long %>%
  mutate(value = ifelse(key == 'pk', NA, value))

y <- bes
long2 <- gather(y, key, value, cases:predicted)
long2$value <- as.numeric(long2$value)

z <- rbind(long %>%
             filter(year >= 2017),
           long2 %>%
             filter(year <= 2016))

ggplot(data = z %>%
         filter(key %in% c('predicted', 'pk'),
                district == 'MAGUDE'),
       aes(x = date,
           y = value,
           group = key,
           color = key)) +
  geom_line() +
  facet_wrap(~age)
```

```{r}
# Plot the observed and counterfactual
plot_data <- counter_factual %>%
  group_by(date) %>%
  summarise(cases = sum(cases),
            cases_cf = sum(cases_cf),
            cases_averted = sum(cases_averted)) %>%
  gather(key, value, cases:cases_averted) %>%
  filter(key != "cases_averted") %>%
  mutate(key = ifelse(key == "cases", "MALTEM", "Counter-factual"))

ggplot(data=plot_data,
       aes(x=date,
           y=value,
           color=key))+
  geom_line(size =2,
            alpha = 0.6) +
  labs(title="Observed malaria cases vs counterfactual",
       subtitle="Post-MDA period, 2016",
       x="Date",
       y="Malaria cases") +
  theme_minimal() +
  scale_color_manual(name = "",
values = c("red", "darkgreen"))
```


##Cost effectiveness analysis


####Cost-effectiveness of MALTEM on malaria

###Cost-effectiveness of MALTEM on mortality



#Results

##Costs 

###Costs elimination (baseline years)

###Costs projection elimination

###Costs projection control

###Costs savings elimination

###Effectiveness (impact)

###Outcome indicators (costing outcomes)

###Impact indicators

###Cost-effectiveness analysis


And here is another figure.

```{r, fig.height = 8}

ggplot(data = df,
       aes(x = date,
           y = pk)) +
  geom_line(aes(color = age)) +
  facet_wrap(~district) +
  labs(x = 'Date',
       y = 'Incidence (cases per 1,000)',
       title = 'Malaria incidence over time by district',
       subtitle = 'Cases per 1,000 inhabitants') +
  scale_color_manual(name = 'Age',
                     values = c('darkgreen', 'darkorange'))
```


```{r}
x <- df %>%
  mutate(magude = ifelse(district == 'MAGUDE', 'Magude', 'Not Magude')) %>%
    filter(district != 'NAMAACHA') %>%
  # filter(district != 'MANHICA') %>%
  group_by(date,
           # year, month,
           # age, 
           magude) %>%
  summarise(#pk = weighted.mean(pk, w = population),
            cases = sum(cases),
            pop = sum(population),
            precip = mean(precip)) %>%
  ungroup %>%
  mutate(p = cases / pop * 1000) #%>%
  # mutate(date = as.Date(paste0(year, '-',
  #                              '06',
  #                              # month, 
  #                              '-01')))# %>%
  # filter(date >= '2014-07-01')

library(ggthemes)
library(cism)
ggplot(data = x,
       aes(x = date,
           color = magude,
           y = p)) +
  geom_line(alpha = 0.6) +
  # geom_smooth() +
  # facet_wrap(~age, ncol = 1) +
  # theme_bw()  +
  scale_color_manual(name = '',
                     values = c('blue', 'red')) +
  # theme_fivethirtyeight() +
  geom_vline(xintercept = as.numeric(as.Date(paste0(2010:2017, '-12-31'))),
             lty = 2, alpha = 0.2) +
  geom_vline(xintercept = as.numeric(as.Date(paste0('2015-03-15'))),
             color = 'darkgreen') +
  labs(x = 'Week',
       y = 'Weekly incidence per 1,000',
       title = 'Weekly clinical malaria',
       subtitle = 'Province of Maputo, all ages, weekly') +
  geom_label(data = data_frame(x = as.Date(paste0('2015-03-15')),
                               y = 15,
                               label = 'MDA'),
             aes(x = x,
                 y = y,
                 label = label),
             color = 'black') +
  theme_cism()
```
# Discussion

```{r}
bes <- bes %>% filter(district != 'NAMAACHA')
# Prediction
bes$predicted <- predict(mod, bes)

x <- bes %>%
    filter(district != 'NAMAACHA') %>%
  # filter(district != 'MANHICA') %>%
  group_by(date,
           # year, month,
           # age, 
           magude) %>%
  summarise(#pk = weighted.mean(pk, w = population),
            cases = sum(cases),
            pop = sum(population),
            precip = mean(precip),
            precip_risk = mean(precipitation_risk),
            predicted = mean(predicted)) %>%
  ungroup %>%
  mutate(p = cases / pop * 1000)
#%>%
  # mutate(date = as.Date(paste0(year, '-',
  #                              '06',
  #                              # month, 
  #                              '-01')))# %>%
  # filter(date >= '2014-07-01')

library(ggthemes)
ggplot(data = x,
       aes(x = date,
           color = magude,
           y = predicted)) +
  geom_line(alpha = 0.6) +
  # geom_smooth() +
  # facet_wrap(~age, ncol = 1) +
  # theme_bw()  +
  scale_color_manual(name = '',
                     values = c('blue', 'red')) +
  theme_fivethirtyeight() +
  geom_vline(xintercept = as.numeric(as.Date(paste0(2010:2017, '-12-31'))),
             lty = 2, alpha = 0.6) +
  geom_vline(xintercept = as.numeric(as.Date(paste0('2015-03-15')))) +
  geom_line(data = x,
            aes(x = date,
                y = p,
                color = magude),
                lty = 2,
            alpha = 0.5)

```

```{r}
# Precipitation
x <- bes %>%
  group_by(year, month) %>%
  summarise(p = mean(precipitation)) %>%
  mutate(date = as.Date(paste0(year, '-', month, '-01')))
ggplot(data = x,
       aes(x = date,
           y = p)) +
  geom_bar(stat = 'identity') 
```
